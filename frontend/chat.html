<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="chat-container" style="display:flex">
    <div class="chat-header">
      <h2>Chat en Tiempo Real</h2>
      <a href="/" class="btn-toggle-chat" style="text-decoration:none; padding:6px 10px">Volver</a>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-form">
      <form id="chat-form">
        <input type="text" id="chat-input" placeholder="Escribe tu mensaje..." autocomplete="off">
        <button type="submit">Enviar</button>
      </form>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Verificar autenticación simple por token en localStorage
    const token = localStorage.getItem('token');
    const user = localStorage.getItem('user');
    if (!token || !user) {
      alert('Debes iniciar sesión para acceder al chat');
      window.location.href = '/';
    }

    const userData = JSON.parse(user);
    const socket = io({ auth: { token } });

    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    socket.on('chat message', (data) => {
      agregarMensaje(data.message, data.username, data.timestamp, data.username !== userData.username);
    });

    socket.on('user joined', (username) => {
      if (username !== userData.username) {
        notificar(`${username} se ha unido al chat`);
      }
    });

    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const mensaje = chatInput.value.trim();
      if (!mensaje) return;
      socket.emit('chat message', { message: mensaje });
      chatInput.value = '';
    });

    function agregarMensaje(mensaje, username, timestamp, esOtro = true) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${esOtro ? 'other' : 'own'}`;
      const infoDiv = document.createElement('div');
      infoDiv.className = 'chat-message-info';
      infoDiv.textContent = `${username} - ${timestamp}`;
      const messageTextDiv = document.createElement('div');
      messageTextDiv.textContent = mensaje;
      messageDiv.appendChild(infoDiv);
      messageDiv.appendChild(messageTextDiv);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function notificar(texto) {
      const div = document.createElement('div');
      div.className = 'user-joined';
      div.textContent = texto;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      setTimeout(() => div.remove(), 3000);
    }
  </script>
</body>
</html>


